<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>jQuery UI Example Page</title>
		<link type="text/css" href="css/smoothness/jquery-ui-1.8.13.custom.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/colorpicker.css" type="text/css" />		
		<style type="text/css">
			table.field {
			border-collapse: separate;
			border-spacing: 0px;
			padding: 0px;
			border: 2px solid black;
			}
			table.field td {
			padding: 0px;
			border: 1px solid black;
			}
			
			table.token {
			border-collapse: separate;
			border-spacing: 0px;
			}
			
			.cell {
			width:20px;
			height:20px;
			}
			
			.cellPix {
			width:2px;
			height:2px;
			float: left;
			}
			
			.fieldCell {
			background-color: green; 
			}
			
			
			.info {
				width:250px;
				background-color: gray;
			}
			
			.bggreen {background-color: green;}
			.bgyellow {background-color: yellow;}
			.bgred {background-color: red;}
			.bggray {background-color: gray;}
		</style>
		<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
		<script type="text/javascript" src="js/colorpicker.js"></script>
		<script type="text/javascript">
			$(function(){
				var tr = "<tr/>";
				var td = "<td/>";
				var cell = "<div class='cell'></div>";
				//var nbr = 3*12;
				/// Creation du battle field
				var field = new BattleField(5 , 5);
				$("#fieldtab1").append(field.GetField());
				
				$("#SaveField").click(function() {
					$("#SaveTextArea").val(JSON.stringify(field));
				});
				//$('table[name="field"] .cell').addClass("fieldCell");
				/////////////////////////////
				// token
				var t = new Token(20,20);
				$("#tokens").append(t.GetToken());
				
				
				//////////////////////////////////////
				//tabs
				$( "#tabs" ).tabs();
				$( "#tabs" ).bind( "tabsshow", function(event, ui) {
					tokenList
					switch(ui.index) {
						case 1 :
							field.SetEditor(true);
							$("#fieldtab2").append($("#fieldtab1 table"));
							break;
						case 0:
							$("#fieldtab1").append($("#fieldtab2 table"));
							break;
					}
					
					if (ui.index != 1) {
						field.SetEditor(false);
						field.SetEditorMode(false);
					}
					
						
				});
				// Colorpicker
				$('#colorpicker').ColorPicker({flat: true ,
									onSubmit: function(hsb, hex, rgb, el) {
										field.SetEditorColor('#' + hex);
									}
				});
				
				//pinceau
				$("#pinceau1").click(function(){field.SetPen(1)});
				$("#pinceau2").click(function(){field.SetPen(2)});
				$("#pinceau3").click(function(){field.SetPen(3)});
				$("#pinceau4").click(function(){field.SetPen(4)});
				$("#pinceau5").click(function(){field.SetPen(5)});
				$("#pinceau6").click(function(){field.SetPen(6)});
				$("#pinceau7").click(function(){field.SetPen(7)});
				$("#pinceau8").click(function(){field.SetPen(8)});
				$("#pinceau9").click(function(){field.SetPen(9)});
				$("#pinceau10").click(function(){field.SetPen(10)});
				
			});
			
			///////////////////////////////////////
			/// BattleField
			function BattleField(w, h)
			{
				var isEditor = false;
				var editorColor = "#FFFFFF";
				var isEditorMode = false;
				var table = $("<table class='field'></table>");
				var width = w;
				var height = h;
				var penPix = 1;
				this.Constructor = function(w, h) {
					var tr = "<tr/>";
					var td = "<td/>";
					var cell = "<div class='cell'></div>";
					var cellPix = "<div class='cellPix'></div>";
					
					for(i=0; i < h; i++)
					{
						table.append(tr);
					}
					for(i=0; i < w; i++)
					{
						table.find('tr').append(td);
					}
					
					table.find('tr td').each(function(index) {
						var fieldCell = $(cell);
						for(i=0; i < 10; i++)
						{
							for(j=0; j < 10; j++)
							{
								var c = $(cellPix);
								var x = (index%width) * 10 + j;
								var y = Math.floor(index/width) * 10 + i;
								c.data("x", x);
								c.data("y", y);
								c.attr('id', 'cell_' + x + '_' + y);
								c.css("background-color", "green");;
								fieldCell.append(c);
							}
						}
						$(this).append(fieldCell);
					});
					
					table.find('.cellPix').bind('mouseover', OnMouseOver);
					table.find('.cellPix').bind('click', OnClick);
				};
				
				this.SetEditor = function(bool)
				{
					isEditor = bool;
				}
				
				this.GetEditor = function(bool)
				{
					return isEditor;
				}
				
				this.SetEditorColor = function(scolor)
				{
					editorColor = scolor;
				}
				
				var OnClick = function () {
					if (isEditor)
						isEditorMode = !isEditorMode;
					
					if (isEditorMode) {
						table.find("td").css("border", "1px solid red");
					}
					else {
						table.find("td").css("border", "1px solid black");
					}
				}
				
				var OnMouseOver = function () {
					if (isEditorMode)
					{	
						var x = $(this).data("x");
						var y = $(this).data("y");
						var total;
						var diff = Math.ceil(penPix / 2)
						x -= diff;
						y -= diff;
						for(i=0; i<penPix; i++)
						{
							for(j=0; j<penPix; j++)
							{
								table.find("#cell_" + (x+i) + "_" + (y+j)).css("background-color", editorColor);
							}
						}
					}
				}
				
				this.GetField = function() {
					return table;
				}
				
				this.SetPen = function(pix) {
					penPix = pix;
				}
				this.Constructor(width, height);
			}
			
			///////////////////////////////////////
			/// Token
			function Token(width, height)
			{
				var token = $("<div class='cell'>&nbsp;</div>");
				var info = $("<div class='info'></div>");
				
				this.Constructor = function (w, h) {
					token.addClass('bggray');
					token.draggable({snap : ".cell", snapMode : "inner"});
					token.mouseover(function() {
						if (!$(this).hasClass( "ui-draggable-dragging" )) {
							var offset = $(this).offset();
							info.show();
							info.offset({ top: offset.top, left: offset.left + 25});
						}
					});
					
					token.mouseout(function() {
						info.hide();
					});
					
					token.mousedown(function() {
						info.hide();
					});
					
					makeInfo();
					
				}
				
				var makeInfo = function() {
					info.append("<input type='text' size='40' style='bold;'></input>");
					info.append("<textarea rows='10' cols='30'></textarea>");
					$("#tokenList").append(info);
				}
				
				this.GetToken = function () {
					return token;
				}
				this.Constructor(width, height);
			}
		</script>
	</head>
	<body>
		<div id="tabs">
			<ul>
				<li><a href="#tabs-1">Battleground</a></li>
				<li><a href="#tabs-2">Configure</a></li>
				<li><a href="#tabs-3">Token List</a></li>
				<li><a href="#tabs-4">Save</a></li>
			</ul>
			<div id="tabs-1">
				<div id="fieldtab1">
					
				</div>
				
				<div id="tokens">
					
				</div>
				
			</div>
			<div id="tabs-2">
				<div id="fieldtab2">
					
				</div>
				<input type="radio" id="pinceau1" name="pinceau">1 pix</input>
				<input type="radio" id="pinceau2" name="pinceau">2 pix</input>
				<input type="radio" id="pinceau3" name="pinceau">3 pix</input>
				<input type="radio" id="pinceau4" name="pinceau">4 pix</input>
				<input type="radio" id="pinceau5" name="pinceau">5 pix</input>
				<input type="radio" id="pinceau6" name="pinceau">6 pix</input>
				<input type="radio" id="pinceau7" name="pinceau">7 pix</input>
				<input type="radio" id="pinceau8" name="pinceau">8 pix</input>
				<input type="radio" id="pinceau9" name="pinceau">9 pix</input>
				<input type="radio" id="pinceau10" name="pinceau">10 pix</input>
				<p id="colorpicker"></p>
			</div>
			<div id="tabs-3">
				<div id="tokenList"></div>
			</div>
			<div id="tabs-4">
				<button type="button" id="SaveField">Save Field</button>
				<input type="textarea" id="SaveTextArea"></input>
				<script type="text/javascript">
					$(function(){
						
					});
				</script>
				<p>Tab 3</p>
			</div>
		</div>
	</body>
</html>